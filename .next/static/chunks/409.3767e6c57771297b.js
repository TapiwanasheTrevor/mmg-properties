"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[409],{10409:function(e,t,o){o.d(t,{Q4:function(){return p},T8:function(){return g},W7:function(){return m},gU:function(){return u},iH:function(){return y},qi:function(){return l},uploadDocument:function(){return n}});var a=o(5978),r=o(60062),i=o(17293),c=o(51149);let d=(0,a.hJ)(i.db,"documents");(0,a.hJ)(i.db,"document_folders");let n=async(e,t,o,n,s)=>{try{var l,u,y;let m=Date.now(),g=e.name.replace(/[^a-zA-Z0-9.-]/g,"_"),p="".concat(m,"_").concat(g),v=t.folderId?"documents/".concat(t.folderId):"documents/general",f=(0,r.iH)(i.tO,"".concat(v,"/").concat(p)),w=await (0,r.KV)(f,e),h=await (0,r.Jt)(w.ref),b={name:t.name,description:t.description,fileName:e.name,fileSize:e.size,mimeType:e.type,category:t.category,tags:t.tags||[],uploadedBy:o,uploadedByName:n,uploadedByRole:s,relatedResource:t.relatedResource,accessLevel:t.accessLevel||"private",permissions:{view:(null===(l=t.permissions)||void 0===l?void 0:l.view)||[o],edit:(null===(u=t.permissions)||void 0===u?void 0:u.edit)||[o],delete:(null===(y=t.permissions)||void 0===y?void 0:y.delete)||[o]},downloadUrl:h,storageRef:w.ref.fullPath,version:1,isActive:!0,metadata:{width:void 0,height:void 0,pageCount:void 0,extractedText:void 0},createdAt:(0,a.Bt)(),updatedAt:(0,a.Bt)()},L=await (0,a.ET)(d,b);return await c.Cv.logDataExport(o,s,"document",{action:"upload",documentId:L.id,fileName:e.name,fileSize:e.size,category:t.category}),L.id}catch(e){throw console.error("Error uploading document:",e),e}},s=async e=>{try{let t=(0,a.JU)(i.db,"documents",e),o=await (0,a.QT)(t);if(o.exists())return{id:o.id,...o.data()};return null}catch(e){throw console.error("Error getting document:",e),e}},l=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{let t=(0,a.IO)(d);e.category&&(t=(0,a.IO)(t,(0,a.ar)("category","==",e.category))),e.relatedResourceType&&e.relatedResourceId&&(t=(0,a.IO)(t,(0,a.ar)("relatedResource.type","==",e.relatedResourceType)),t=(0,a.IO)(t,(0,a.ar)("relatedResource.id","==",e.relatedResourceId))),e.uploadedBy&&(t=(0,a.IO)(t,(0,a.ar)("uploadedBy","==",e.uploadedBy))),e.accessLevel&&(t=(0,a.IO)(t,(0,a.ar)("accessLevel","==",e.accessLevel))),void 0!==e.isActive&&(t=(0,a.IO)(t,(0,a.ar)("isActive","==",e.isActive))),t=(0,a.IO)(t,(0,a.Xo)("createdAt","desc")),e.pageSize&&(t=(0,a.IO)(t,(0,a.b9)(e.pageSize)));let o=await (0,a.PL)(t),r=[];return o.forEach(e=>{r.push({id:e.id,...e.data()})}),{documents:r,total:r.length}}catch(e){throw console.error("Error getting documents:",e),e}},u=async(e,t,o,r)=>{try{let d=(0,a.JU)(i.db,"documents",e);await (0,a.r7)(d,{...t,updatedAt:(0,a.Bt)()}),await c.Cv.logDataExport(o,r,"document",{action:"update",documentId:e,updates:t})}catch(e){throw console.error("Error updating document:",e),e}},y=async(e,t,o)=>{try{let d=await s(e);if(!d)throw Error("Document not found");let n=(0,r.iH)(i.tO,d.storageRef);await (0,r.oq)(n);let l=(0,a.JU)(i.db,"documents",e);await (0,a.oe)(l),await c.Cv.logDataExport(t,o,"document",{action:"delete",documentId:e,fileName:d.fileName})}catch(e){throw console.error("Error deleting document:",e),e}},m=async function(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{let{documents:a}=await l({pageSize:1e3}),r=a.filter(e=>"public"===e.accessLevel||e.permissions.view.includes(t)||e.uploadedBy===t),i=e.toLowerCase();return r.filter(t=>{var a,r;let c=!e||t.name.toLowerCase().includes(i)||(null===(a=t.description)||void 0===a?void 0:a.toLowerCase().includes(i))||t.fileName.toLowerCase().includes(i)||t.tags.some(e=>e.toLowerCase().includes(i)),d=!o.category||t.category===o.category,n=!(null===(r=o.tags)||void 0===r?void 0:r.length)||o.tags.some(e=>t.tags.includes(e)),s=t.createdAt.toDate(),l=!o.dateFrom||s>=o.dateFrom,u=!o.dateTo||s<=o.dateTo;return c&&d&&n&&l&&u}).sort((e,t)=>t.createdAt.toDate().getTime()-e.createdAt.toDate().getTime())}catch(e){throw console.error("Error searching documents:",e),e}},g=async e=>{try{let{documents:t}=await l({pageSize:1e4}),o=e?t.filter(t=>t.uploadedBy===e):t,a={total:o.length,totalSize:o.reduce((e,t)=>e+t.fileSize,0),byCategory:{},byAccessLevel:{},byMimeType:{},recentUploads:o.sort((e,t)=>t.createdAt.toDate().getTime()-e.createdAt.toDate().getTime()).slice(0,10),largestFiles:o.sort((e,t)=>t.fileSize-e.fileSize).slice(0,10)};return o.forEach(e=>{a.byCategory[e.category]=(a.byCategory[e.category]||0)+1,a.byAccessLevel[e.accessLevel]=(a.byAccessLevel[e.accessLevel]||0)+1,a.byMimeType[e.mimeType]=(a.byMimeType[e.mimeType]||0)+1}),a}catch(e){throw console.error("Error getting document statistics:",e),e}},p=(e,t,o)=>{var a;return e.uploadedBy===t||"view"===o&&"public"===e.accessLevel||(null===(a=e.permissions[o])||void 0===a?void 0:a.includes(t))||!1}}}]);