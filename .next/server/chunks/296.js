"use strict";exports.id=296,exports.ids=[296],exports.modules={11296:(e,t,a)=>{a.d(t,{Q4:()=>p,T8:()=>g,W7:()=>y,gU:()=>u,iH:()=>m,qi:()=>n,uploadDocument:()=>d});var r=a(76),o=a(11552),i=a(20902),c=a(63324);let s=(0,r.hJ)(i.db,"documents");(0,r.hJ)(i.db,"document_folders");let d=async(e,t,a,d,l)=>{try{let n=Date.now(),u=e.name.replace(/[^a-zA-Z0-9.-]/g,"_"),m=`${n}_${u}`,y=t.folderId?`documents/${t.folderId}`:"documents/general",g=(0,o.iH)(i.tO,`${y}/${m}`),p=await (0,o.KV)(g,e),w=await (0,o.Jt)(p.ref),v={name:t.name,description:t.description,fileName:e.name,fileSize:e.size,mimeType:e.type,category:t.category,tags:t.tags||[],uploadedBy:a,uploadedByName:d,uploadedByRole:l,relatedResource:t.relatedResource,accessLevel:t.accessLevel||"private",permissions:{view:t.permissions?.view||[a],edit:t.permissions?.edit||[a],delete:t.permissions?.delete||[a]},downloadUrl:w,storageRef:p.ref.fullPath,version:1,isActive:!0,metadata:{width:void 0,height:void 0,pageCount:void 0,extractedText:void 0},createdAt:(0,r.Bt)(),updatedAt:(0,r.Bt)()},h=await (0,r.ET)(s,v);return await c.Cv.logDataExport(a,l,"document",{action:"upload",documentId:h.id,fileName:e.name,fileSize:e.size,category:t.category}),h.id}catch(e){throw console.error("Error uploading document:",e),e}},l=async e=>{try{let t=(0,r.JU)(i.db,"documents",e),a=await (0,r.QT)(t);if(a.exists())return{id:a.id,...a.data()};return null}catch(e){throw console.error("Error getting document:",e),e}},n=async(e={})=>{try{let t=(0,r.IO)(s);e.category&&(t=(0,r.IO)(t,(0,r.ar)("category","==",e.category))),e.relatedResourceType&&e.relatedResourceId&&(t=(0,r.IO)(t,(0,r.ar)("relatedResource.type","==",e.relatedResourceType)),t=(0,r.IO)(t,(0,r.ar)("relatedResource.id","==",e.relatedResourceId))),e.uploadedBy&&(t=(0,r.IO)(t,(0,r.ar)("uploadedBy","==",e.uploadedBy))),e.accessLevel&&(t=(0,r.IO)(t,(0,r.ar)("accessLevel","==",e.accessLevel))),void 0!==e.isActive&&(t=(0,r.IO)(t,(0,r.ar)("isActive","==",e.isActive))),t=(0,r.IO)(t,(0,r.Xo)("createdAt","desc")),e.pageSize&&(t=(0,r.IO)(t,(0,r.b9)(e.pageSize)));let a=await (0,r.PL)(t),o=[];return a.forEach(e=>{o.push({id:e.id,...e.data()})}),{documents:o,total:o.length}}catch(e){throw console.error("Error getting documents:",e),e}},u=async(e,t,a,o)=>{try{let s=(0,r.JU)(i.db,"documents",e);await (0,r.r7)(s,{...t,updatedAt:(0,r.Bt)()}),await c.Cv.logDataExport(a,o,"document",{action:"update",documentId:e,updates:t})}catch(e){throw console.error("Error updating document:",e),e}},m=async(e,t,a)=>{try{let s=await l(e);if(!s)throw Error("Document not found");let d=(0,o.iH)(i.tO,s.storageRef);await (0,o.oq)(d);let n=(0,r.JU)(i.db,"documents",e);await (0,r.oe)(n),await c.Cv.logDataExport(t,a,"document",{action:"delete",documentId:e,fileName:s.fileName})}catch(e){throw console.error("Error deleting document:",e),e}},y=async(e,t,a={})=>{try{let{documents:r}=await n({pageSize:1e3}),o=r.filter(e=>"public"===e.accessLevel||e.permissions.view.includes(t)||e.uploadedBy===t),i=e.toLowerCase();return o.filter(t=>{let r=!e||t.name.toLowerCase().includes(i)||t.description?.toLowerCase().includes(i)||t.fileName.toLowerCase().includes(i)||t.tags.some(e=>e.toLowerCase().includes(i)),o=!a.category||t.category===a.category,c=!a.tags?.length||a.tags.some(e=>t.tags.includes(e)),s=t.createdAt.toDate(),d=!a.dateFrom||s>=a.dateFrom,l=!a.dateTo||s<=a.dateTo;return r&&o&&c&&d&&l}).sort((e,t)=>t.createdAt.toDate().getTime()-e.createdAt.toDate().getTime())}catch(e){throw console.error("Error searching documents:",e),e}},g=async e=>{try{let{documents:t}=await n({pageSize:1e4}),a=e?t.filter(t=>t.uploadedBy===e):t,r={total:a.length,totalSize:a.reduce((e,t)=>e+t.fileSize,0),byCategory:{},byAccessLevel:{},byMimeType:{},recentUploads:a.sort((e,t)=>t.createdAt.toDate().getTime()-e.createdAt.toDate().getTime()).slice(0,10),largestFiles:a.sort((e,t)=>t.fileSize-e.fileSize).slice(0,10)};return a.forEach(e=>{r.byCategory[e.category]=(r.byCategory[e.category]||0)+1,r.byAccessLevel[e.accessLevel]=(r.byAccessLevel[e.accessLevel]||0)+1,r.byMimeType[e.mimeType]=(r.byMimeType[e.mimeType]||0)+1}),r}catch(e){throw console.error("Error getting document statistics:",e),e}},p=(e,t,a)=>e.uploadedBy===t||"view"===a&&"public"===e.accessLevel||e.permissions[a]?.includes(t)||!1}};